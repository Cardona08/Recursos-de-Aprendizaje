<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Educativo Cecytem</title>
    <link rel="stylesheet" href="../static/Inicio.css">
    <!-- Script de inactividad -->
  <script>
    const INACTIVIDAD_TIEMPO = 5 * 60 * 1000; // 5 minutos
    let temporizadorInactividad;

    function cerrarSesion() {
      alert("Se ha cerrado la sesi√≥n por inactividad.");
      window.location.href = "/logout";
    }

    function reiniciarTemporizador() {
      clearTimeout(temporizadorInactividad);
      temporizadorInactividad = setTimeout(cerrarSesion, INACTIVIDAD_TIEMPO);
    }

    function iniciarDeteccionInactividad() {
      ["mousemove", "keypress", "click", "scroll"].forEach(evento => {
        document.addEventListener(evento, reiniciarTemporizador);
      });
      reiniciarTemporizador();
    }

    window.onload = iniciarDeteccionInactividad;
  </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Portal Educativo</h1>
            <p class="subtitle">Sistema de Gesti√≥n Integral</p>
        </header>

        <!-- Indicador de voz -->
        <div class="voice-status" id="voiceStatus">
            <div class="pulse-dot"></div>
            <span>Escuchando...</span>
        </div>

        <!-- Barra de b√∫squeda con micr√≥fono -->
        <div class="search-container">
            <span class="search-icon" onclick="toggleSearch()">üîç</span>
            <span class="mic-icon" id="micIcon" onclick="toggleVoiceSearch()">üé§</span>
            <input 
                type="text" 
                id="searchBar" 
                class="search-bar" 
                placeholder="Buscar alumnos, docentes, orientadores..."
                oninput="buscarEnTodo()"
            >
        </div>

        <!-- Resultados de b√∫squeda -->
        <div class="search-results" id="searchResults">
            <h2>Resultados de b√∫squeda (<span id="resultCount">0</span>)</h2>
            <div id="resultsContainer"></div>
        </div>

        <div class="no-results" id="noResults">
            No se encontraron resultados para tu b√∫squeda üòï
        </div>

        <div class="grid" id="mainGrid">
            <a href="{{ url_for('grupos') }}" class="card alumnos">
                <div class="icon-container">üë®‚Äçüéì</div>
                <h2 class="card-title">Alumnos</h2>
                <p class="card-description">Gesti√≥n de estudiantes, expedientes acad√©micos y seguimiento del rendimiento escolar</p>
            </a>

            <a href="{{ url_for('docentes') }}" class="card docentes">
                <div class="icon-container">üë®‚Äçüè´</div>
                <h2 class="card-title">Docentes</h2>
                <p class="card-description">Portal de profesores, planificaci√≥n de clases y recursos pedag√≥gicos</p>
            </a>

            <a href="{{ url_for('orientadores') }}" class="card orientadores">
                <div class="icon-container">üë©‚Äçüíº</div>
                <h2 class="card-title">Orientadores</h2>
                <p class="card-description">Asesoramiento acad√©mico, seguimiento personalizado y apoyo estudiantil</p>
            </a>

            <a href="{{ url_for('directivos') }}" class="card directivos">
                <div class="icon-container">üëî</div>
                <h2 class="card-title">Directivos</h2>
                <p class="card-description">Panel administrativo, reportes ejecutivos y gesti√≥n institucional</p>
            </a>
            <a href="{{ url_for('materias') }}" class="card materias">
                <div class="icon-container">üìö</div>
                <h2 class="card-title">Materias</h2>
                <p class="card-description">Cat√°logo de asignaturas, programas de estudio y recursos did√°cticos</p>
            </a>
            <a href="{{ url_for('ayuda') }}" class="card ayuda">
                <div class="icon-container">‚ùì</div>
                <h2 class="card-title">Ayuda</h2>
                <p class="card-description">Centro de soporte, preguntas frecuentes y asistencia t√©cnica</p>
            </a>
            <a href="{{ url_for('avisos') }}" class="card avisos">
                <div class="icon-container">‚ùó</div>
                <h2 class="card-title">Avisos</h2>
                <p class="card-description">Panel de Avisos o Indicaciones del Plantel</p>
            </a>
        </div>
    </div>

    <script>
        // RECONOCIMIENTO DE VOZ
        let recognition = null;
        let isListening = false;

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'es-ES';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = function() {
                    isListening = true;
                    document.getElementById('micIcon').classList.add('listening');
                    document.getElementById('voiceStatus').classList.add('active');
                };

                recognition.onresult = function(event) {
                    let transcript = event.results[0][0].transcript;
                    transcript = transcript.replace(/[.,;:!?]$/g, '').trim();
                    
                    const searchBar = document.getElementById('searchBar');
                    
                    if (!searchBar.classList.contains('active')) {
                        searchBar.classList.add('active');
                    }
                    
                    searchBar.value = transcript;
                    buscarEnTodo();
                };

                recognition.onerror = function(event) {
                    console.error('Error en reconocimiento de voz:', event.error);
                    if (event.error === 'no-speech') {
                        alert('No se detect√≥ ninguna voz. Intenta de nuevo.');
                    } else if (event.error === 'not-allowed') {
                        alert('Permiso de micr√≥fono denegado. Por favor, habilita el micr√≥fono en tu navegador.');
                    }
                };

                recognition.onend = function() {
                    isListening = false;
                    document.getElementById('micIcon').classList.remove('listening');
                    document.getElementById('voiceStatus').classList.remove('active');
                };
            }
        }

        function toggleVoiceSearch() {
            if (!recognition) {
                initSpeechRecognition();
            }

            if (!recognition) {
                alert('Tu navegador no soporta reconocimiento de voz. Por favor, usa Chrome, Edge o Safari.');
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function toggleSearch() {
            const searchBar = document.getElementById('searchBar');
            searchBar.classList.toggle('active');
            
            if (searchBar.classList.contains('active')) {
                searchBar.focus();
            } else {
                searchBar.value = '';
                buscarEnTodo();
            }
        }

        // ========================================
        // FUNCI√ìN DE B√öSQUEDA COMPLETA (ALUMNOS Y EMPLEADOS DESDE BASE DE DATOS)
        // ========================================
        async function buscarEnTodo() {
            const searchTerm = document.getElementById('searchBar').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('resultsContainer');
            const searchResults = document.getElementById('searchResults');
            const noResults = document.getElementById('noResults');
            const mainGrid = document.getElementById('mainGrid');
            const resultCount = document.getElementById('resultCount');

            if (!searchTerm) {
                searchResults.classList.remove('active');
                noResults.style.display = 'none';
                mainGrid.style.display = 'grid';
                return;
            }

            let results = [];
            
            // Buscar ALUMNOS en la base de datos
            try {
                const responseAlumnos = await fetch(`/api/buscar-alumnos?q=${encodeURIComponent(searchTerm)}`);
                const dataAlumnos = await responseAlumnos.json();
                
                dataAlumnos.alumnos.forEach(alumno => {
                    results.push({
                        tipo: 'alumno',
                        nombre: alumno.nombre,
                        matricula: alumno.matricula,
                        grupo: alumno.grupo,
                        semestre: alumno.semestre
                    });
                });
            } catch (error) {
                console.error('Error al buscar alumnos:', error);
            }

            // Buscar EMPLEADOS en la base de datos
            try {
                const responseEmpleados = await fetch(`/api/buscar-empleados?q=${encodeURIComponent(searchTerm)}`);
                const dataEmpleados = await responseEmpleados.json();
                
                dataEmpleados.empleados.forEach(empleado => {
                    results.push({
                        tipo: 'empleado',
                        nombre: empleado.nombre,
                        numeroEmpleado: empleado.numeroEmpleado,
                        tipoEmpleado: empleado.tipo,
                        usuario: empleado.usuario
                    });
                });
            } catch (error) {
                console.error('Error al buscar empleados:', error);
            }

            // Mostrar resultados
            if (results.length > 0) {
                mainGrid.style.display = 'none';
                searchResults.classList.add('active');
                noResults.style.display = 'none';
                resultCount.textContent = results.length;
                
                resultsContainer.innerHTML = results.map(result => {
                    if (result.tipo === 'alumno') {
                        // Determinar el HTML del grupo
                        let grupoHtml = `${result.grupo}.html`;
                        
                        return `
                            <div class="result-item">
                                <a href="${grupoHtml}?matricula=${result.matricula}&nombre=${encodeURIComponent(result.nombre)}">
                                    <div class="result-name">${result.nombre}</div>
                                    <div class="result-info">Matr√≠cula: ${result.matricula}</div>
                                    <span class="result-badge">Alumno</span>
                                    <span class="result-badge" style="background: #764ba2;">Grupo ${result.grupo}</span>
                                    <span class="result-badge" style="background: #20c997;">${result.semestre}¬∞ Semestre</span>
                                </a>
                            </div>
                        `;
                    } else {
                        // Colores seg√∫n tipo de empleado
                        let colorBadge = '#28a745';
                        let tipoBadge = result.tipoEmpleado;
                        
                        if (result.tipoEmpleado === 'directora' || result.tipoEmpleado === 'subdirectora' || result.tipoEmpleado === 'coordinadora') {
                            colorBadge = '#dc3545';
                            tipoBadge = result.tipoEmpleado.charAt(0).toUpperCase() + result.tipoEmpleado.slice(1);
                        } else if (result.tipoEmpleado === 'orientadora' || result.tipoEmpleado === 'orientador') {
                            colorBadge = '#17a2b8';
                            tipoBadge = 'Orientador(a)';
                        } else {
                            tipoBadge = 'Docente';
                        }
                        
                        return `
                            <div class="result-item">
                                <div class="result-name">${result.nombre}</div>
                                <div class="result-info">N√∫mero de empleado: ${result.numeroEmpleado}</div>
                                <div class="result-info">Usuario: ${result.usuario}</div>
                                <span class="result-badge" style="background: ${colorBadge};">${tipoBadge}</span>
                            </div>
                        `;
                    }
                }).join('');
            } else {
                mainGrid.style.display = 'none';
                searchResults.classList.remove('active');
                noResults.style.display = 'block';
            }
        }

        // Cerrar b√∫squeda al presionar Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const searchBar = document.getElementById('searchBar');
                if (searchBar.classList.contains('active')) {
                    toggleSearch();
                }
                
                if (isListening && recognition) {
                    recognition.stop();
                }
            }
        });

        // Inicializar reconocimiento de voz al cargar la p√°gina
        window.addEventListener('load', function() {
            initSpeechRecognition();
        });
    </script>
</body>
</html>